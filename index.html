<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./main.css">
    <title>Zip Maker</title>
</head>

<body>
    <main class="zip-app container">
        <header>
            <h1>üìÅ Zip papka yaratuvchi</h1>
            <p>Bu sayt orqali rasmlarni zip papkaga solsangiz boladi</p>
        </header>

        <section class="zip-name-section">
            <h2>1. Papkangizga nom bering</h2>
            <div class="input-group">
                <input type="text" id="zipName" placeholder="misol uchun 10v Kelajak soati" required>
            </div>
        </section>

        <section class="zip-pictures-section">
            <h2>2. Rasmlarni yuklang</h2>
            <div class="input-group file-upload-group">
                <label for="imageInput" class="file-label">
                    <span>üñºÔ∏è Rasmlarni tanglang</span>
                </label>
                <input type="file" multiple accept="image/*" id="imageInput" style="display: none;" />

                <p id="file-status" class="muted hidden"></p>
                <ul id="file-list" class="file-list"></ul>
            </div>
        </section>

        <section class="zip-download-section">
            <button class="download-btn" id="download_zip">
                ‚¨áÔ∏è Zip papkani yuklab oling
            </button>
            <div id="status" class="status-card" aria-live="polite"></div>
        </section>

    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const button = document.getElementById("download_zip");
        const status = document.getElementById("status");
        const imageInput = document.getElementById("imageInput");
        const fileStatus = document.getElementById("file-status");
        const fileList = document.getElementById("file-list");
        const zipNameInput = document.getElementById("zipName");
        let selectedFiles = [];

        const setStatus = (message, type = "") => {
            status.textContent = message;
            status.className = `status-card ${type}`.trim();
        };

        const renderFileList = (files) => {
            fileList.innerHTML = "";

            if (files.length === 0) {
                fileStatus.textContent = "";
                fileStatus.classList.add("hidden");
                return;
            }

            fileStatus.classList.remove("muted");
            fileStatus.classList.remove("hidden");
            fileStatus.textContent = files.length === 1
                ? "1 ta rasm tanlandi"
                : `${files.length} ta rasm tanlandi`;

            const maxPreview = 5;
            Array.from(files)
                .slice(0, maxPreview)
                .forEach((file) => {
                    const item = document.createElement("li");
                    item.textContent = file.name;
                    fileList.appendChild(item);
                });

            if (files.length > maxPreview) {
                const more = document.createElement("li");
                more.textContent = `... yana ${files.length - maxPreview} ta`;
                fileList.appendChild(more);
            }
        };

        imageInput.addEventListener("change", (event) => {
            const newFiles = Array.from(event.target.files);

            if (newFiles.length === 0) {
                return;
            }

            const combined = [...selectedFiles, ...newFiles];

            if (combined.length > 10) {
                setStatus("Maksimum 10 ta rasm tanlang", "error");
                imageInput.value = "";
                return;
            }

            selectedFiles = combined;
            renderFileList(selectedFiles);
            setStatus("");
            imageInput.value = "";
        });

        button.addEventListener("click", async () => {
            const files = selectedFiles;
            const zipName = zipNameInput.value.trim();

            if (!zipName) {
                setStatus("Iltimos papka nomini kiriting", "error");
                return;
            }

            if (files.length === 0) {
                setStatus("Iltimos kamida bitta rasmni tanlang", "error");
                return;
            }

            if (files.length > 10) {
                setStatus("Maksimum 10 ta rasm tanlang", "error");
                return;
            }

            try {
                button.disabled = true;
                setStatus("Zip papka yaratilmoqda...", "info");

                const zip = new JSZip();
                for (const file of files) {
                    zip.file(file.name, file);
                }

                const blob = await zip.generateAsync({ type: "blob" });
                const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

                if (isMobile) {
                    // Try to share directly from the browser (Telegram will appear in the system share sheet if installed)
                    const zipFile = new File([blob], `${zipName}.zip`, { type: "application/zip" });

                    if (navigator.canShare && navigator.canShare({ files: [zipFile] })) {
                        try {
                            await navigator.share({
                                files: [zipFile],
                                title: zipName,
                                text: "Zip faylini ulashyapsiz"
                            });
                            setStatus("Zip tayyor. Telegram yoki boshqa ilovaga ulash muvaffaqiyatli boshlandi. Yordamim tekgan bo'lsa 10 ball kutaman)", "success");
                        } catch (shareError) {
                            // NotAllowedError ko'p hollarda foydalanuvchi ulash oynasini yopgani yoki bekor qilganini anglatadi.
                            console.warn("Share cancelled by user or not allowed", shareError);
                            setStatus("Zip tayyor. Ulash oynasi yopildi yoki bekor qilindi, xohlasangiz yana 'Zip papkani yuklab oling' tugmasini bosing.", "info");
                        }
                    } else {
                        setStatus("Zip fayl tayyor, lekin brauzeringiz faylni to'g'ridan-to'g'ri ulashni qo'llab-quvvatlamaydi. Iltimos kompyuterdan yuklab olib, Telegramga yuboring.", "error");
                    }
                } else {
                    const blobUrl = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = blobUrl;
                    link.download = `${zipName}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    setStatus("Zip papka yuklanishi boshlandi. Telefon/kompyuteringizda yuklangan fayl odatda 'Downloads' / 'Yuklamalar' papkasiga saqlanadi. Yordamim tekgan bo'lsa 10 ball kutaman)", "success");

                    setTimeout(() => URL.revokeObjectURL(blobUrl), 10000);
                }
            } catch (error) {
                console.error(error);
                setStatus("Xatolik yuz berdi, qayta urinib ko'ring", "error");
            } finally {
                button.disabled = false;
            }
        });
    </script>

</body>

</html>